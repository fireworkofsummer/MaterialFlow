<view class="container">
  <!-- åŸºæœ¬ä¿¡æ¯ -->
  <view class="form-section">
    <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
    
    <view class="form-group">
      <text class="form-label">å‡ºåº“å•å·</text>
      <view class="form-display">{{form.outboundNumber}}</view>
    </view>
    
    <view class="form-group">
      <text class="form-label required">å‡ºåº“æ—¥æœŸ</text>
      <picker
        mode="date"
        value="{{form.outboundDate}}"
        bindchange="onFormInput"
        data-field="outboundDate"
      >
        <view class="picker-display">
          {{form.outboundDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}
        </view>
      </picker>
    </view>
    
    <view class="form-group">
      <text class="form-label">é¢†æ–™äºº/é¡¹ç›®</text>
      <input
        class="form-input"
        placeholder="è¯·è¾“å…¥é¢†æ–™äººæˆ–é¡¹ç›®åç§°"
        value="{{form.recipient}}"
        data-field="recipient"
        bindinput="onFormInput"
      />
    </view>
    
    <view class="form-group">
      <text class="form-label">ç»æ‰‹äºº</text>
      <input
        class="form-input"
        placeholder="è¯·è¾“å…¥ç»æ‰‹äººå§“å"
        value="{{form.operator}}"
        data-field="operator"
        bindinput="onFormInput"
      />
    </view>
  </view>

  <!-- æ·»åŠ ç‰©æ–™ -->
  <view class="form-section">
    <view class="section-title">æ·»åŠ ç‰©æ–™</view>
    
    <view class="form-group" wx:if="{{availableMaterials.length > 0}}">
      <text class="form-label required">é€‰æ‹©ç‰©æ–™</text>
      <picker
        mode="selector"
        range="{{availableMaterialOptions}}"
        value="{{selectedMaterialIndex + 1}}"
        bindchange="onMaterialChange"
      >
        <view class="picker-display">
          {{selectedMaterialName || 'è¯·é€‰æ‹©ç‰©æ–™'}}
        </view>
      </picker>
      
      <!-- æ˜¾ç¤ºå½“å‰åº“å­˜ -->
      <view class="stock-info" wx:if="{{newItem.materialId}}">
        <text class="stock-label">å½“å‰åº“å­˜:</text>
        <text class="stock-value">
          {{selectedMaterialStock}}{{selectedMaterialUnit}}
        </text>
      </view>
    </view>
    
    <!-- æ— åº“å­˜æç¤º -->
    <view class="no-stock" wx:else>
      <view class="no-stock-icon">ğŸ“¦</view>
      <view class="no-stock-text">æš‚æ— å¯å‡ºåº“çš„ç‰©æ–™</view>
    </view>
    
    <view class="form-group" wx:if="{{newItem.materialId}}">
      <text class="form-label required">å‡ºåº“æ•°é‡</text>
      <input
        class="form-input"
        placeholder="è¯·è¾“å…¥å‡ºåº“æ•°é‡"
        value="{{newItem.quantity}}"
        data-field="quantity"
        bindinput="onItemInput"
        type="digit"
      />
    </view>
    
    <!-- æˆæœ¬é¢„è§ˆ -->
    <view class="cost-preview" wx:if="{{showCostPreview && costPreview && !costPreview.error}}">
      <view class="preview-title">FIFOæˆæœ¬é¢„è§ˆ</view>
      <view class="preview-summary">
        <view class="summary-item">
          <text class="summary-label">å‡ºåº“æ•°é‡:</text>
          <text class="summary-value">{{costPreview.quantity}}{{costPreview.unit}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æ€»æˆæœ¬:</text>
          <text class="summary-value cost-value">Â¥{{costPreview.totalCostFormatted}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">å¹³å‡æˆæœ¬:</text>
          <text class="summary-value">Â¥{{costPreview.averagePriceFormatted}}/{{costPreview.unit}}</text>
        </view>
      </view>
      
      <view class="batch-details">
        <view class="details-title">æ‰¹æ¬¡æ¶ˆè€—æ˜ç»†:</view>
        <view 
          class="batch-item"
          wx:for="{{costPreview.batchDetails}}" 
          wx:key="batchId"
        >
          <view class="batch-date">{{item.displayDate}}</view>
          <view class="batch-quantity">{{item.consumedQuantity}}{{costPreview.unit}}</view>
          <view class="batch-price">Â¥{{item.unitPrice}}</view>
          <view class="batch-cost">Â¥{{item.costFormatted}}</view>
        </view>
      </view>
    </view>
    
    <!-- é”™è¯¯æç¤º -->
    <view class="error-tip" wx:if="{{costPreview && costPreview.error}}">
      <text class="error-icon">âš ï¸</text>
      <text class="error-text">{{costPreview.error}}</text>
    </view>
    
    <view class="btn-secondary" bindtap="onAddItem" wx:if="{{newItem.materialId && newItem.quantity}}">
      æ·»åŠ åˆ°æ¸…å•
    </view>
  </view>

  <!-- å‡ºåº“æ¸…å• -->
  <view class="form-section" wx:if="{{form.items.length > 0}}">
    <view class="section-title">å‡ºåº“æ¸…å• ({{form.items.length}})</view>
    
    <view class="item-list">
      <view 
        class="item-card"
        wx:for="{{form.items}}" 
        wx:key="materialId"
      >
        <view class="item-header">
          <view class="item-name">{{item.materialName}}</view>
          <view class="item-actions">
            <view class="action-detail" bindtap="onViewItemDetail" data-item="{{item}}">
              <text class="detail-icon">â„¹ï¸</text>
            </view>
            <view class="item-delete" bindtap="onDeleteItem" data-index="{{index}}">
              <text class="delete-icon">âœ•</text>
            </view>
          </view>
        </view>
        
        <view class="item-info">
          <view class="info-row">
            <text class="info-label">è§„æ ¼:</text>
            <text class="info-value">{{item.specification}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ•°é‡:</text>
            <text class="info-value">{{item.quantity}}{{item.unit}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">å¹³å‡æˆæœ¬:</text>
            <text class="info-value">Â¥{{item.averageCostFormatted}}/{{item.unit}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ€»æˆæœ¬:</text>
            <text class="info-value total-cost">Â¥{{item.totalCostFormatted || item.totalCost.toFixed(2)}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ€»è®¡ -->
    <view class="total-section">
      <view class="total-row">
        <text class="total-label">æ€»æˆæœ¬:</text>
        <text class="total-value">Â¥{{totalCostFormatted || totalCost.toFixed(2)}}</text>
      </view>
    </view>
  </view>

  <!-- å¤‡æ³¨ -->
  <view class="form-section">
    <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
    
    <view class="form-group">
      <textarea
        class="form-textarea"
        placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
        value="{{form.remark}}"
        data-field="remark"
        bindinput="onFormInput"
        maxlength="200"
      />
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-section">
    <view class="btn-secondary" bindtap="onCancel">å–æ¶ˆ</view>
    <view class="btn-primary" bindtap="onSave">ä¿å­˜å‡ºåº“</view>
  </view>
</view>
